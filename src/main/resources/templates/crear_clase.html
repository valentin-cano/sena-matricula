<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <title>Crear Clase</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

    <div th:replace="~{fragments/navbar :: barra-navegacion}"></div>

    <div class="container mt-5">
        <h2 class="fw-bold mb-4">✍️ Reservar una Nueva Clase</h2>

        <form th:action="@{/clase/guardar}" method="post">

            <div class="mb-3">
                <label for="alumno" class="form-label">Selecciona el Alumno</label>
                <select class="form-select" id="alumno" name="alumno.id" required>
                    <option value="">-- Selecciona un alumno --</option>
                    <option th:each="alumno : ${alumnos}"
                            th:value="${alumno.id}"
                            th:text="${alumno.nombre + ' ' + alumno.apellidos}">
                    </option>
                </select>
            </div>

            <div class="mb-3">
                <label for="materia" class="form-label">Selecciona la Materia</label>
                <select class="form-select" id="materia" name="materia.id" required>
                    <option value="">-- Selecciona una Materia --</option>
                    <option th:each="materia : ${materias}"
                            th:value="${materia.id}"
                            th:text="${materia.nombre}">
                    </option>
                </select>
            </div>
            
            <button type="button" id="consultarDocentesBtn" class="btn btn-info mb-3">Consultar Docentes Disponibles</button>

            <div class="mb-3">
                <label for="docente" class="form-label">Selecciona el Docente</label>
                <select class="form-select" id="docente" name="docente.id" required disabled>
                    <option value="">-- Docentes disponibles --</option>
                </select>
            </div>

            <button type="button" id="consultarHorariosBtn" class="btn btn-info mb-3" disabled>Consultar Disponibilidad Horaria</button>

            <div class="mb-3">
                <label for="disponibilidad" class="form-label">Selecciona el Horario Disponible</label>
                <select class="form-select" id="disponibilidad" name="disponibilidadHoraria.id" required disabled>
                    <option value="">-- Horarios disponibles --</option>
                </select>
            </div>
            
            <button type="submit" class="btn btn-success">Guardar Clase</button>
        </form>
    </div>

    <div th:replace="~{fragments/footer :: pie-pagina}"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const materiaSelect = document.getElementById('materia');
            const docenteSelect = document.getElementById('docente');
            const consultarDocentesBtn = document.getElementById('consultarDocentesBtn');

            const consultarHorariosBtn = document.getElementById('consultarHorariosBtn');
            const disponibilidadSelect = document.getElementById('disponibilidad');

            consultarDocentesBtn.addEventListener('click', function() {
                const materiaId = materiaSelect.value;
                
                docenteSelect.innerHTML = '<option value="">-- Docentes disponibles --</option>';
                docenteSelect.disabled = true;
                
                consultarHorariosBtn.disabled = true;
                disponibilidadSelect.innerHTML = '<option value="">-- Horarios disponibles --</option>';
                disponibilidadSelect.disabled = true;

                if (materiaId) {
                    fetch(`/clase/docentesPorMateria/${materiaId}`)
                        .then(response => {
                            if (!response.ok) throw new Error('Error al obtener los docentes. Código: ' + response.status);
                            return response.json();
                        })
                        .then(data => {
                            docenteSelect.disabled = false;
                            consultarHorariosBtn.disabled = false;
                            
                            if (data && data.length > 0) {
                                data.forEach(docenteMateria => {
                                    const docente = docenteMateria.id_docente;
                                    if (docente) {
                                        const option = document.createElement('option');
                                        option.value = docente.id;
                                        option.textContent = docente.nombre + ' ' + docente.apellidos;
                                        docenteSelect.appendChild(option);
                                    }
                                });
                            } else {
                                const option = document.createElement('option');
                                option.textContent = "No hay docentes para esta materia";
                                docenteSelect.appendChild(option);
                                consultarHorariosBtn.disabled = true;
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            const option = document.createElement('option');
                            option.textContent = "Error al cargar los docentes";
                            docenteSelect.appendChild(option);
                            docenteSelect.disabled = false; 
                        });
                }
            });

            consultarHorariosBtn.addEventListener('click', function() {
                const docenteId = docenteSelect.value;
                
                disponibilidadSelect.innerHTML = '<option value="">-- Horarios disponibles --</option>';
                disponibilidadSelect.disabled = true;

                if (docenteId) {
                    fetch(`/disponibilidad/encontrar/${docenteId}`)
                        .then(response => {
                            if (!response.ok) throw new Error('Error al obtener los horarios. Código: ' + response.status);
                            return response.json();
                        })
                        .then(data => {
                            disponibilidadSelect.disabled = false;

                            if (data && data.length > 0) {
                                data.forEach(horarioDisponible => {
                                    const horario = horarioDisponible.id_horario;
                                    if (horario) {
                                        const option = document.createElement('option');
                                        option.value = horarioDisponible.id; // ID de la disponibilidad
                                        option.textContent = `${horario.dia} - ${horario.hora}`;
                                        disponibilidadSelect.appendChild(option);
                                    }
                                });
                            } else {
                                const option = document.createElement('option');
                                option.textContent = "No hay horarios disponibles para este docente";
                                disponibilidadSelect.appendChild(option);
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            const option = document.createElement('option');
                            option.textContent = "Error al cargar los horarios";
                            disponibilidadSelect.appendChild(option);
                            disponibilidadSelect.disabled = false;
                        });
                }
            });
        });
    </script>
</body>
</html>
